<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salle des Troph√©es - Math√©magie</title>
    <link rel="icon" type="image/png" href="images/logo_transparant.png">
    <link rel="stylesheet" href="style/commun.css">
    <script src="js/profils.js"></script>
    <script src="js/composants/header.js" defer></script>
    <style>
        .trophees-section-titre {
            font-family: 'Lexend', sans-serif;
            font-weight: 800;
            font-size: 1.4rem;
            color: var(--primary-color);
            margin-top: 40px;
            margin-bottom: 10px;
        }
        .trophees-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 30px;
            margin-top: 15px;
        }
        .trophee-carte {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            text-align: center;
            border: 4px solid #E2E8F0;
            border-bottom-width: 8px;
            border-bottom-color: #CBD5E1;
            transition: all 0.3s ease;
            opacity: 0.5;
            filter: grayscale(1);
            cursor: default;
        }
        .trophee-carte.debloque {
            opacity: 1;
            filter: grayscale(0);
            border-color: var(--primary-color);
            border-bottom-color: #A077EE;
        }
        .trophee-carte:hover {
            transform: translateY(-6px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        .trophee-carte.debloque:hover {
            box-shadow: 0 12px 28px rgba(160, 119, 238, 0.3);
        }
        .trophee-icone {
            font-size: 4rem;
            margin-bottom: 15px;
            display: block;
            transition: transform 0.3s ease;
        }
        .trophee-carte:hover .trophee-icone {
            transform: scale(1.15) rotate(-5deg);
        }
        .trophee-nom {
            font-family: 'Lexend', sans-serif;
            font-weight: 800;
            color: var(--primary-color);
            display: block;
            margin-bottom: 5px;
        }
        .trophee-condition {
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        .stats-globales {
            background: var(--primary-color);
            color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(160, 119, 238, 0.3);
        }
        .stats-globales h3 { color: white; margin-bottom: 5px; font-size: 1.3rem; }
        .stats-globales p { font-size: 1.1rem; }
        .stats-avatar {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            font-size: 2.2rem;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .stats-titre {
            font-size: 0.9rem;
            opacity: 0.85;
            margin-top: 3px;
        }
        /* Avatars d√©bloquables */
        .avatars-deblocables-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        .avatar-deb-carte {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            border: 3px solid #E2E8F0;
            transition: all 0.3s ease;
        }
        .avatar-deb-carte.debloque {
            border-color: var(--success-color);
            background: linear-gradient(135deg, rgba(107, 203, 119, 0.05), rgba(107, 203, 119, 0.1));
        }
        .avatar-deb-carte.verrouille {
            opacity: 0.55;
            filter: grayscale(0.5);
        }
        .avatar-deb-icone {
            font-size: 2.5rem;
            display: block;
            margin-bottom: 8px;
        }
        .avatar-deb-nom {
            font-family: 'Lexend', sans-serif;
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--primary-color);
            display: block;
            margin-bottom: 4px;
        }
        .avatar-deb-condition {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .avatar-deb-statut {
            font-size: 0.75rem;
            font-weight: 700;
            margin-top: 6px;
            display: block;
        }
    </style>
</head>
<body>
    <app-header base-path=""></app-header>
    <main>
        <section class="hero-text">
            <h2>Ta Salle des Troph√©es üèÜ</h2>
            <p>D√©couvre tous les badges que tu as gagn√©s en t'entra√Ænant !</p>
        </section>

        <div id="stats-resume" class="stats-globales" role="status" aria-live="polite"></div>

        <div id="trophees-conteneur">
            <!-- Inject√© par JS -->
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const missionsCalcul = [
                { id: 'additions', nom: 'Apprenti Additionneur', icone: 'üü¢' },
                { id: 'soustractions', nom: 'Mage des Soustractions', icone: 'üîµ' },
                { id: 'multiplications', nom: 'Grand Multiplicateur', icone: 'üî¥' },
                { id: 'divisions', nom: 'Ma√Ætre Diviseur', icone: 'üü£' }
            ];

            const missionsGeometrie = [
                { id: 'geometrie-formes', nom: 'Gardien des Formes', icone: 'üìê' },
                { id: 'geometrie-proprietes', nom: 'Expert des Propri√©t√©s', icone: 'üîç' },
                { id: 'geometrie-angles', nom: 'Ma√Ætre des Angles', icone: 'üìê' },
                { id: 'geometrie-symetrie', nom: 'Gardien de la Sym√©trie', icone: 'ü™û' },
                { id: 'geometrie-vraifaux', nom: 'D√©tecteur de V√©rit√©', icone: '‚úÖ' },
                { id: 'geometrie-droites', nom: 'Ma√Ætre des Droites', icone: 'üìè' },
                { id: 'geometrie-triangles', nom: 'Oracle des Triangles', icone: 'üíé' },
                { id: 'geometrie-quadrilateres', nom: 'Prince des Quadrilat√®res', icone: 'ü™Å' },
                { id: 'geometrie-patrons', nom: 'Archimage des Solides', icone: 'üì¶' }
            ];

            // Garde d'acc√®s
            gestionnaireProfils.verifierAccesOuRediriger('');

            const conteneur = document.getElementById('trophees-conteneur');
            let debloques = 0;
            const toutesLesMissions = [...missionsCalcul, ...missionsGeometrie];

            // Paliers par cat√©gorie : g√©om√©trie (max 3) et calculs (max 10)
            const paliersCalcul = [
                { seuil: 10, badge: 'üíé' },
                { seuil: 7, badge: 'ü•á' },
                { seuil: 4, badge: 'ü•à' },
                { seuil: 2, badge: 'ü•â' }
            ];
            const paliersGeometrie = [
                { seuil: 3, badge: 'ü•á' },
                { seuil: 2, badge: 'ü•â' }
            ];

            function getBadge(niv, paliers) {
                for (const p of paliers) {
                    if (niv >= p.seuil) return p.badge;
                }
                return '';
            }

            function creerSection(titre, missions, paliers) {
                const titreSec = document.createElement('h3');
                titreSec.className = 'trophees-section-titre';
                titreSec.textContent = titre;
                conteneur.appendChild(titreSec);

                const grille = document.createElement('div');
                grille.className = 'trophees-grid';
                grille.setAttribute('role', 'list');
                grille.setAttribute('aria-label', `Troph√©es ${titre}`);
                conteneur.appendChild(grille);

                missions.forEach(mission => {
                    const data = gestionnaireProfils.getProgression(mission.id);
                    const niv = data?.niveau || 1;
                    const estDebloque = niv >= 2;
                    if (estDebloque) debloques++;

                    const badge = getBadge(niv, paliers);

                    const carte = document.createElement('div');
                    carte.className = `trophee-carte ${estDebloque ? 'debloque' : ''}`;
                    carte.setAttribute('role', 'listitem');
                    carte.setAttribute('aria-label', `${mission.nom} ‚Äî ${estDebloque ? `Niveau ${niv} ${badge}` : 'Pas encore d√©bloqu√©'}`);

                    carte.innerHTML = `
                        <span class="trophee-icone" role="img" aria-hidden="true">${mission.icone}</span>
                        <span class="trophee-nom">${mission.nom}</span>
                        <span class="trophee-condition">${estDebloque ? `Niveau ${niv} ${badge}` : 'Pas encore d√©bloqu√©'}</span>
                    `;
                    grille.appendChild(carte);
                });
            }

            creerSection('üßÆ Calculs Mentaux', missionsCalcul, paliersCalcul);
            creerSection('üìê G√©om√©trie', missionsGeometrie, paliersGeometrie);

            // R√©sum√© de progression avec avatar
            const nomMage = gestionnaireProfils.getJoueurActif();
            const avatarMage = gestionnaireProfils.getAvatar();
            const couleurMage = gestionnaireProfils.getCouleur();
            const titreMage = gestionnaireProfils.getTitreMage();

            function ajusterCouleur(hex, amount) {
                let r = parseInt(hex.slice(1, 3), 16);
                let g = parseInt(hex.slice(3, 5), 16);
                let b = parseInt(hex.slice(5, 7), 16);
                r = Math.min(255, r + amount);
                g = Math.min(255, g + amount);
                b = Math.min(255, b + amount);
                return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
            }

            const statsResume = document.getElementById('stats-resume');
            statsResume.style.background = `linear-gradient(135deg, ${couleurMage}, ${ajusterCouleur(couleurMage, -20)})`;
            statsResume.innerHTML = `
                <div class="stats-avatar" style="background: linear-gradient(135deg, ${couleurMage}, ${ajusterCouleur(couleurMage, 40)})">${avatarMage}</div>
                <h3>${nomMage}</h3>
                <p class="stats-titre">${titreMage}</p>
                <p>${debloques} / ${toutesLesMissions.length} missions d√©bloqu√©es</p>
            `;

            // Section avatars d√©bloquables
            const { debloquesInfos } = gestionnaireProfils.getAvatarsDisponibles();

            const titreAvatars = document.createElement('h3');
            titreAvatars.className = 'trophees-section-titre';
            titreAvatars.textContent = 'üîì Avatars Sp√©ciaux';
            conteneur.appendChild(titreAvatars);

            const grilleAvatars = document.createElement('div');
            grilleAvatars.className = 'avatars-deblocables-grid';
            conteneur.appendChild(grilleAvatars);

            debloquesInfos.forEach(info => {
                const carte = document.createElement('div');
                carte.className = `avatar-deb-carte ${info.debloque ? 'debloque' : 'verrouille'}`;
                carte.innerHTML = `
                    <span class="avatar-deb-icone">${info.debloque ? info.emoji : 'üîí'}</span>
                    <span class="avatar-deb-nom">${info.nom}</span>
                    <span class="avatar-deb-condition">${info.condition}</span>
                    <span class="avatar-deb-statut" style="color: ${info.debloque ? 'var(--success-color)' : 'var(--text-muted)'}">
                        ${info.debloque ? '‚úÖ D√©bloqu√© !' : 'üîí Verrouill√©'}
                    </span>
                `;
                grilleAvatars.appendChild(carte);
            });
        });
    </script>
</body>
</html>
